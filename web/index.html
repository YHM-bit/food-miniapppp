<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <title>Cook Today</title>

  <style>
    :root{--bg:#0b0f14;--bg2:#070a0f;--text:#e9eef5;--muted:rgba(233,238,245,.70);--card:rgba(255,255,255,.06);--card2:rgba(255,255,255,.04);--stroke:rgba(255,255,255,.10);--shadow:0 16px 40px rgba(0,0,0,.35);--accent:#4da3ff;--accent2:#7c5cff;--radius:18px;--tabH:78px;}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);
      background:radial-gradient(900px 600px at 10% -5%, color-mix(in srgb, var(--accent) 28%, transparent), transparent 60%),
      radial-gradient(800px 500px at 110% 10%, color-mix(in srgb, var(--accent2) 22%, transparent), transparent 62%),
      radial-gradient(900px 700px at 40% 120%, color-mix(in srgb, var(--accent) 16%, transparent), transparent 60%),
      linear-gradient(180deg, var(--bg), var(--bg2));min-height:100vh;}
    .wrap{max-width:760px;margin:0 auto;padding:16px 14px calc(var(--tabH) + 18px);}
    .header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:14px;}
    .title{margin:0;font-size:22px;font-weight:900;letter-spacing:.2px;}
    .sub{margin:6px 0 0 0;color:var(--muted);font-size:13px;line-height:1.35;}
    .card{border:1px solid var(--stroke);border-radius:var(--radius);background:linear-gradient(180deg, var(--card), var(--card2));box-shadow:var(--shadow);padding:14px;}
    .balanceBlock{padding:18px 16px;border-radius:22px;border:1px solid var(--stroke);background:linear-gradient(180deg, color-mix(in srgb, var(--card) 110%, transparent), var(--card2));box-shadow:0 18px 48px rgba(0,0,0,.25);margin-bottom:14px;}
    .balanceK{font-size:12px;color:var(--muted);margin-bottom:8px;}
    .balanceV{font-size:38px;font-weight:1000;letter-spacing:.6px;line-height:1;}
    .balanceMeta{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;color:var(--muted);font-size:12px;}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:color-mix(in srgb, var(--card) 130%, transparent);display:inline-flex;align-items:center;gap:8px;}
    .actionRow{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:14px;}
    .actionBtn{border:1px solid var(--stroke);background:color-mix(in srgb, var(--card) 120%, transparent);color:var(--text);border-radius:16px;padding:12px 10px;font-weight:800;text-align:center;cursor:pointer;user-select:none;transition:transform .08s ease, background .2s ease;}
    .actionBtn:active{transform:scale(.98)}
    .actionIcon{font-size:18px;display:block;margin-bottom:6px;}
    .actionSub{font-size:11px;color:var(--muted);font-weight:700;margin-top:2px}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:12px;}
    .item{border:1px solid var(--stroke);border-radius:18px;background:color-mix(in srgb, var(--card) 115%, transparent);padding:12px 12px;display:flex;align-items:center;justify-content:space-between;gap:12px;cursor:pointer;user-select:none;}
    .itemL{display:flex;align-items:center;gap:10px;min-width:0;}
    .badge{width:36px;height:36px;border-radius:14px;border:1px solid var(--stroke);display:grid;place-items:center;background:radial-gradient(18px 18px at 30% 30%, color-mix(in srgb, var(--accent) 28%, transparent), transparent 65%),color-mix(in srgb, var(--card) 140%, transparent);flex:0 0 auto;}
    .itemTitle{font-weight:900;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .itemDesc{font-size:12px;color:var(--muted);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .chev{color:var(--muted);font-weight:900;}
    .tab{display:none;} .tab.active{display:block;}
    .dish{margin-top:12px;border:1px solid var(--stroke);border-radius:20px;background:color-mix(in srgb, var(--card) 120%, transparent);padding:14px;}
    .dishName{font-size:18px;font-weight:1000;margin:0 0 8px 0;}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 0 0;}
    .chip{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:color-mix(in srgb, var(--card) 145%, transparent);color:var(--muted);}
    .chip.accent{color:var(--text);border-color:color-mix(in srgb, var(--accent) 45%, var(--stroke));background:color-mix(in srgb, var(--accent) 14%, transparent);}
    .dishWhy{margin:10px 0 0 0;color:var(--muted);font-size:13px;line-height:1.45}
    .out{margin-top:12px;border:1px solid var(--stroke);border-radius:20px;background:color-mix(in srgb, var(--card) 115%, transparent);padding:12px;}
    .outHead{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .outTitle{font-weight:950;font-size:13px}
    pre{white-space:pre-wrap;margin:10px 0 0 0;font-size:13px;line-height:1.45}
    .formGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
    .field label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px;}
    select,input{width:100%;padding:12px 12px;border-radius:16px;border:1px solid var(--stroke);background:color-mix(in srgb, var(--card) 130%, transparent);color:var(--text);outline:none;}
    option{color:#111}
    .checks{display:flex;gap:14px;flex-wrap:wrap;margin-top:12px;}
    .chk{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:13px}
    .chk input{width:18px;height:18px}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    .btn{border:1px solid var(--stroke);background:color-mix(in srgb, var(--card) 135%, transparent);color:var(--text);border-radius:16px;padding:12px 12px;font-weight:900;cursor:pointer;user-select:none;}
    .btn.primary{border-color:color-mix(in srgb, var(--accent) 45%, var(--stroke));background:linear-gradient(135deg,color-mix(in srgb, var(--accent) 18%, transparent),color-mix(in srgb, var(--accent2) 14%, transparent));}
    .tabbar{position:fixed;left:0;right:0;bottom:0;height:var(--tabH);padding:10px 12px 14px;background:color-mix(in srgb, var(--bg) 85%, transparent);backdrop-filter:blur(14px);border-top:1px solid var(--stroke);display:flex;justify-content:center;z-index:50;}
    .tabbarInner{width:min(760px,100%);display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;}
    .tabbtn{border:1px solid transparent;border-radius:18px;background:transparent;color:var(--muted);padding:10px 8px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;cursor:pointer;user-select:none;}
    .tabbtn .ic{font-size:18px} .tabbtn .lb{font-size:11px;font-weight:900}
    .tabbtn.active{background:color-mix(in srgb, var(--card) 150%, transparent);border-color:var(--stroke);color:var(--text);}
    @media (max-width:520px){.formGrid{grid-template-columns:1fr;}.balanceV{font-size:34px}}
    .debug{margin-top:10px;font-size:12px;color:var(--muted)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1 class="title" id="uiTitle">Najjednostavniji recepti</h1>
        <p class="sub" id="uiSub">Cook Today ‚Ä¢ daily dish ‚Ä¢ ingredients ‚Ä¢ steps ‚Ä¢ filters</p>
      </div>
      <div class="pill"><span>üîç</span><span id="statusText">Loading‚Ä¶</span></div>
    </div>

    <div class="tab active" id="tab_home">
      <div class="balanceBlock">
        <div class="balanceK" id="balK">Balance</div>
        <div class="balanceV" id="balV">‚Äî</div>
        <div class="balanceMeta">
          <span class="pill" id="meta1">üéÅ Trial: ‚Äî</span>
          <span class="pill" id="meta2">ü™ô Tokens: ‚Äî</span>
        </div>

        <div class="actionRow">
          <div class="actionBtn" id="btnDaily"><span class="actionIcon">‚¨áÔ∏è</span><span id="tDaily">Daily dish</span><div class="actionSub" id="tDailySub">Updates</div></div>
          <div class="actionBtn" id="btnRecipe"><span class="actionIcon">‚¨ÜÔ∏è</span><span id="tRecipe">Recipe</span><div class="actionSub" id="tRecipeSub">Steps</div></div>
          <div class="actionBtn" id="btnWallet"><span class="actionIcon">‚ÜïÔ∏è</span><span id="tWallet">Tokens</span><div class="actionSub" id="tWalletSub">Balance</div></div>
        </div>

        <div class="debug" id="dbg"></div>
      </div>

      <div class="card">
        <div style="font-weight:950; font-size:14px" id="homeH">Today's dish</div>
        <div id="dishBox" class="dish" style="display:none"></div>
        <div id="outBox" class="out" style="display:none"></div>

        <div class="list">
          <div class="item" id="goFilters"><div class="itemL"><div class="badge">‚öôÔ∏è</div><div><div class="itemTitle" id="homeFiltersT">Settings / Filters</div><div class="itemDesc" id="homeFiltersD">Diet, time</div></div></div><div class="chev">‚Ä∫</div></div>
          <div class="item" id="goHow"><div class="itemL"><div class="badge">üìå</div><div><div class="itemTitle" id="homeHowT">How it works</div><div class="itemDesc" id="homeHowD">Trial ‚Üí tokens</div></div></div><div class="chev">‚Ä∫</div></div>
        </div>
      </div>
    </div>

    <div class="tab" id="tab_recipe">
      <div class="card">
        <div style="font-weight:950; font-size:14px" id="recH">Recipe</div>
        <div class="actionRow" style="margin-top:12px">
          <div class="actionBtn" id="btnIng"><span class="actionIcon">üßæ</span><span id="tIng">Ingredients</span><div class="actionSub" id="tIngSub">List</div></div>
          <div class="actionBtn" id="btnSteps"><span class="actionIcon">üë®‚Äçüç≥</span><span id="tSteps">Steps</span><div class="actionSub" id="tStepsSub">How</div></div>
          <div class="actionBtn" id="btnTime"><span class="actionIcon">‚è±</span><span id="tTime">Time</span><div class="actionSub" id="tTimeSub">Approx</div></div>
        </div>
        <div id="dishBox2" class="dish" style="display:none;margin-top:12px"></div>
        <div id="outBox2" class="out" style="display:none;margin-top:12px"></div>
      </div>
    </div>

    <div class="tab" id="tab_filters">
      <div class="card">
        <div style="font-weight:950; font-size:14px" id="filH">Settings</div>

        <div class="formGrid">
          <div class="field">
            <label id="lLang">üåè Language</label>
            <select id="lang">
              <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
              <option value="hr">Hrvatski</option>
              <option value="en">English</option>
            </select>
          </div>

          <div class="field">
            <label id="lDiet">Diet</label>
            <select id="diet">
              <option value="any">any</option>
              <option value="vegetarian">vegetarian</option>
              <option value="vegan">vegan</option>
              <option value="pescatarian">pescatarian</option>
            </select>
          </div>

          <div class="field">
            <label id="lMax">Max time</label>
            <select id="max_time">
              <option value="0">‚àû</option>
              <option value="15">15</option>
              <option value="30">30</option>
              <option value="45">45</option>
              <option value="60">60</option>
            </select>
          </div>

          <div class="field">
            <label id="lExcl">Exclude (comma)</label>
            <input id="exclude" placeholder="onion, garlic ..." />
          </div>
        </div>

        <div class="checks">
          <label class="chk"><input type="checkbox" id="gluten_free"> gluten_free</label>
          <label class="chk"><input type="checkbox" id="lactose_free"> lactose_free</label>
          <label class="chk"><input type="checkbox" id="high_protein"> high_protein</label>
          <label class="chk"><input type="checkbox" id="low_calorie"> low_calorie</label>
        </div>

        <div class="btnRow">
          <button class="btn primary" id="btnSave">üíæ <span id="tSave">Save</span></button>
          <button class="btn" id="btnRefresh">üîÑ <span id="tRefresh">Refresh</span></button>
        </div>
      </div>
    </div>

    <div class="tab" id="tab_wallet">
      <div class="card">
        <div style="font-weight:950; font-size:14px">Wallet</div>
        <div style="color:var(--muted);font-size:13px;margin-top:6px">Stars payment next step.</div>
      </div>
    </div>
  </div>

  <div class="tabbar">
    <div class="tabbarInner">
      <div class="tabbtn active" data-tab="home"><div class="ic">üè†</div><div class="lb" id="tbHome">Home</div></div>
      <div class="tabbtn" data-tab="recipe"><div class="ic">üìñ</div><div class="lb" id="tbRecipe">Recipe</div></div>
      <div class="tabbtn" data-tab="filters"><div class="ic">‚öôÔ∏è</div><div class="lb" id="tbFilters">Filters</div></div>
      <div class="tabbtn" data-tab="wallet"><div class="ic">üëõ</div><div class="lb" id="tbWallet">Wallet</div></div>
    </div>
  </div>

<script>
  // ‚úÖ IMPORTANT: set your Render backend URL here
  const API_BASE = "https://food-miniapppp.onrender.com";

  const tg = window.Telegram?.WebApp;
  try { tg?.ready?.(); tg?.expand?.(); } catch(e){}

  const I18N = {
    uk:{uiTitle:"Najjednostavniji recepti",uiSub:"Cook Today ‚Ä¢ —Å—Ç—Ä–∞–≤–∞ –¥–Ω—è ‚Ä¢ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏ ‚Ä¢ —Ä–µ—Ü–µ–ø—Ç ‚Ä¢ —Ñ—ñ–ª—å—Ç—Ä–∏",
      balK:"–ó–∞–≥–∞–ª—å–Ω–∏–π –±–∞–ª–∞–Ω—Å",homeH:"–°—å–æ–≥–æ–¥–Ω—ñ—à–Ω—è —Å—Ç—Ä–∞–≤–∞",daily:"–°—Ç—Ä–∞–≤–∞ –¥–Ω—è",dailySub:"–û–Ω–æ–≤–ª—é—î—Ç—å—Å—è —â–æ–¥–Ω—è",
      recipe:"–†–µ—Ü–µ–ø—Ç",recipeSub:"–ö—Ä–æ–∫–∏ –ø—Ä–∏–≥–æ—Ç—É–≤–∞–Ω–Ω—è",wallet:"–¢–æ–∫–µ–Ω–∏",walletSub:"–ë–∞–ª–∞–Ω—Å —ñ –±–æ–Ω—É—Å–∏",
      ing:"–Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏",steps:"–ö—Ä–æ–∫–∏",time:"–ß–∞—Å",ingSub:"–°–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç—ñ–≤",stepsSub:"–ü–æ–∫—Ä–æ–∫–æ–≤–æ",timeSub:"–ü—Ä–∏–±–ª–∏–∑–Ω–æ",
      filtersT:"–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è / –§—ñ–ª—å—Ç—Ä–∏",filtersD:"–î—ñ—î—Ç–∞, —á–∞—Å, –≤–∏–∫–ª—é—á–µ–Ω–Ω—è —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤",howT:"–Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î",
      howD:"Trial 7 –¥–Ω—ñ–≤, –ø–æ—Ç—ñ–º —Ç–æ–∫–µ–Ω–∏ + –±–æ–Ω—É—Å–∏",tbHome:"–ì–æ–ª–æ–≤–Ω–∞",tbRecipe:"–†–µ—Ü–µ–ø—Ç",tbFilters:"–§—ñ–ª—å—Ç—Ä–∏",tbWallet:"–ì–∞–º–∞–Ω–µ—Ü—å",
      filH:"–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è",lLang:"üåè –ú–æ–≤–∞",lDiet:"–î—ñ—î—Ç–∞",lMax:"–ú–∞–∫—Å —á–∞—Å",lExcl:"–í–∏–∫–ª—é—á–∏—Ç–∏ (—á–µ—Ä–µ–∑ –∫–æ–º—É)",save:"–ó–±–µ—Ä–µ–≥—Ç–∏",refresh:"–û–Ω–æ–≤–∏—Ç–∏",
      outIng:"üßæ –Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏",outSteps:"üë®‚Äçüç≥ –ö—Ä–æ–∫–∏",outTime:"‚è± –ß–∞—Å",noDish:"–ù–µ–º–∞—î —Å—Ç—Ä–∞–≤–∏ –ø—ñ–¥ —Ü—ñ —Ñ—ñ–ª—å—Ç—Ä–∏",noTokens:"–ù–µ–º–∞—î —Ç–æ–∫–µ–Ω—ñ–≤ üòï",
      howTitle:"–Ø–∫ –ø—Ä–∞—Ü—é—î",howMsg:"Refresh –¥–∞—î —ñ–Ω—à—É —Å—Ç—Ä–∞–≤—É –ø—ñ–¥ —Ñ—ñ–ª—å—Ç—Ä–∏."},
    hr:{uiTitle:"Najjednostavniji recepti",uiSub:"Cook Today ‚Ä¢ jelo dana ‚Ä¢ sastojci ‚Ä¢ recept ‚Ä¢ filteri",
      balK:"Ukupni balans",homeH:"Dana≈°nje jelo",daily:"Jelo dana",dailySub:"Mijenja se svaki dan",
      recipe:"Recept",recipeSub:"Koraci pripreme",wallet:"Tokeni",walletSub:"Stanje i bonusi",
      ing:"Sastojci",steps:"Koraci",time:"Vrijeme",ingSub:"Popis namirnica",stepsSub:"Korak po korak",timeSub:"Otprilike",
      filtersT:"Postavke / Filteri",filtersD:"Dijeta, vrijeme, izbacivanje sastojaka",howT:"Kako radi",
      howD:"Trial 7 dana, zatim tokeni + bonusi",tbHome:"Poƒçetna",tbRecipe:"Recept",tbFilters:"Filteri",tbWallet:"Novƒçanik",
      filH:"Postavke",lLang:"üåè Jezik",lDiet:"Dijeta",lMax:"Max vrijeme",lExcl:"Izbaci (zarez)",save:"Spremi",refresh:"Osvje≈æi",
      outIng:"üßæ Sastojci",outSteps:"üë®‚Äçüç≥ Koraci",outTime:"‚è± Vrijeme",noDish:"Nema jela za ove filtre",noTokens:"Nema tokena üòï",
      howTitle:"Kako radi",howMsg:"Refresh daje drugo jelo po filterima."},
    en:{uiTitle:"Najjednostavniji recepti",uiSub:"Cook Today ‚Ä¢ daily dish ‚Ä¢ ingredients ‚Ä¢ steps ‚Ä¢ filters",
      balK:"Total balance",homeH:"Today's dish",daily:"Dish of the day",dailySub:"Updates daily",
      recipe:"Recipe",recipeSub:"Cooking steps",wallet:"Tokens",walletSub:"Balance & bonuses",
      ing:"Ingredients",steps:"Steps",time:"Time",ingSub:"Grocery list",stepsSub:"Step by step",timeSub:"Approximate",
      filtersT:"Settings / Filters",filtersD:"Diet, time, exclusions",howT:"How it works",
      howD:"7-day trial, then tokens + bonuses",tbHome:"Home",tbRecipe:"Recipe",tbFilters:"Filters",tbWallet:"Wallet",
      filH:"Settings",lLang:"üåè Language",lDiet:"Diet",lMax:"Max time",lExcl:"Exclude (comma)",save:"Save",refresh:"Refresh",
      outIng:"üßæ Ingredients",outSteps:"üë®‚Äçüç≥ Steps",outTime:"‚è± Time",noDish:"No dish matches these filters",noTokens:"No tokens üòï",
      howTitle:"How it works",howMsg:"Refresh gets a different dish matching filters."}
  };

  let LANG = "uk";
  let STATUS = null;
  let DISH = null;

  function dbg(msg){ document.getElementById("dbg").textContent = msg; }

  function T(){ return I18N[LANG] || I18N.uk; }
  function setText(id, val){ const el=document.getElementById(id); if(el) el.textContent = val; }

  function setUi(){
    const t=T();
    setText("uiTitle",t.uiTitle); setText("uiSub",t.uiSub);
    setText("balK",t.balK); setText("homeH",t.homeH);
    setText("tDaily",t.daily); setText("tDailySub",t.dailySub);
    setText("tRecipe",t.recipe); setText("tRecipeSub",t.recipeSub);
    setText("tWallet",t.wallet); setText("tWalletSub",t.walletSub);
    setText("tIng",t.ing); setText("tIngSub",t.ingSub);
    setText("tSteps",t.steps); setText("tStepsSub",t.stepsSub);
    setText("tTime",t.time); setText("tTimeSub",t.timeSub);
    setText("homeFiltersT",t.filtersT); setText("homeFiltersD",t.filtersD);
    setText("homeHowT",t.howT); setText("homeHowD",t.howD);
    setText("tbHome",t.tbHome); setText("tbRecipe",t.tbRecipe); setText("tbFilters",t.tbFilters); setText("tbWallet",t.tbWallet);
    setText("filH",t.filH); setText("lLang",t.lLang); setText("lDiet",t.lDiet); setText("lMax",t.lMax); setText("lExcl",t.lExcl);
    setText("tSave",t.save); setText("tRefresh",t.refresh);
  }

  async function api(path, method="GET", body=null){
    const initData = tg?.initData || "";
    const headers = {"Content-Type":"application/json"};
    if(initData) headers["X-Telegram-Init-Data"] = initData;

    const url = API_BASE + path;
    const res = await fetch(url, {method, headers, body: body ? JSON.stringify(body) : null});
    if(!res.ok) throw new Error((await res.text()) || ("HTTP "+res.status));
    return res.json();
  }

  function showPopup(title, message){
    try{ tg?.showPopup?.({title, message, buttons:[{type:"ok"}]}); }
    catch(e){ alert(title + "\n" + message); }
  }

  function renderDish(d){
    DISH=d;
    const b1=document.getElementById("dishBox");
    const b2=document.getElementById("dishBox2");
    if(!d){ b1.style.display="none"; b2.style.display="none"; return; }
    const tags=(d.tags||[]).slice(0,6);
    const chips=[`<span class="chip accent">‚è± ~${d.time_total_min} min</span>`, ...tags.map(x=>`<span class="chip">${x}</span>`)].join("");
    const html=`<div class="dishName">${d.title}</div><div class="chips">${chips}</div><div class="dishWhy">${d.why||""}</div>`;
    b1.innerHTML=html; b2.innerHTML=html; b1.style.display="block"; b2.style.display="block";
  }

  function renderOut(title,data,target=1){
    const box = (target===1)?document.getElementById("outBox"):document.getElementById("outBox2");
    if(!data){ box.style.display="none"; return; }
    const body = Array.isArray(data)? data.map((x,i)=>`${i+1}. ${x}`).join("\n") : String(data);
    box.innerHTML=`<div class="outHead"><div class="outTitle">${title}</div><div class="chip">${DISH?DISH.title:"‚Äî"}</div></div><pre>${body}</pre>`;
    box.style.display="block";
  }

  function setStatusText(){
    if(!STATUS) return;
    const el=document.getElementById("statusText");
    el.textContent = STATUS.trial ? `Trial: ${STATUS.trial_days_left} days` : `Tokens: ${STATUS.tokens}`;
    document.getElementById("balV").textContent = STATUS.trial ? "TRIAL" : String(STATUS.tokens);
    document.getElementById("meta1").textContent = STATUS.trial ? `üéÅ Trial: ${STATUS.trial_days_left} days` : `üéÅ Trial: 0 days`;
    document.getElementById("meta2").textContent = `ü™ô Tokens: ${STATUS.tokens}`;
  }

  async function refreshStatus(){
    STATUS = await api("/api/status");
    LANG = STATUS.lang || LANG || "uk";
    document.getElementById("lang").value = LANG;
    setUi();
    setStatusText();

    const f=STATUS.filters||{};
    document.getElementById("diet").value = f.diet ?? "any";
    document.getElementById("max_time").value = String(f.max_time ?? 0);
    document.getElementById("exclude").value = (f.exclude||[]).join(", ");
    ["gluten_free","lactose_free","high_protein","low_calorie"].forEach(k=>document.getElementById(k).checked=!!f[k]);

    dbg(`API=${API_BASE} ‚Ä¢ demo=${STATUS.demo} ‚Ä¢ lang=${LANG}`);
  }

  async function loadDaily(reset=false){
    const t=T();
    const r = await api("/api/daily","POST",{reset, lang: LANG});
    renderDish(r.dish);
    renderOut("",null,1); renderOut("",null,2);
    if(!r.dish) showPopup("Info", t.noDish);
  }

  async function loadAction(action){
    const t=T();
    const r = await api("/api/action","POST",{action, lang: LANG});
    if(action==="ingredients") renderOut(t.outIng,r.data,2);
    if(action==="steps") renderOut(t.outSteps,r.data,2);
    if(action==="time") renderOut(t.outTime,(r.data??0)+" min",2);
  }

  function setTab(name){
    ["home","recipe","filters","wallet"].forEach(x=>{
      document.getElementById("tab_"+x).classList.toggle("active", x===name);
      document.querySelector(`.tabbtn[data-tab="${x}"]`).classList.toggle("active", x===name);
    });
  }

  // wiring
  document.querySelectorAll(".tabbtn").forEach(b=>b.addEventListener("click",()=>setTab(b.dataset.tab)));
  document.getElementById("btnDaily").onclick=()=>loadDaily(true); // ‚úÖ always reset when tap
  document.getElementById("btnRecipe").onclick=()=>setTab("recipe");
  document.getElementById("btnWallet").onclick=()=>setTab("wallet");
  document.getElementById("btnIng").onclick=()=>loadAction("ingredients");
  document.getElementById("btnSteps").onclick=()=>loadAction("steps");
  document.getElementById("btnTime").onclick=()=>loadAction("time");
  document.getElementById("goFilters").onclick=()=>setTab("filters");
  document.getElementById("goHow").onclick=()=>showPopup(T().howTitle,T().howMsg);

  document.getElementById("btnSave").onclick=async ()=>{
    const payload={
      diet:document.getElementById("diet").value,
      max_time:parseInt(document.getElementById("max_time").value,10),
      gluten_free:document.getElementById("gluten_free").checked,
      lactose_free:document.getElementById("lactose_free").checked,
      high_protein:document.getElementById("high_protein").checked,
      low_calorie:document.getElementById("low_calorie").checked,
      exclude:document.getElementById("exclude").value.split(",").map(s=>s.trim()).filter(Boolean)
    };
    await api("/api/filters","POST",payload);
    await refreshStatus();
    await loadDaily(true);
  };

  document.getElementById("btnRefresh").onclick=async ()=>{
    await refreshStatus();
    await loadDaily(true);
  };

  document.getElementById("lang").onchange=async ()=>{
    const newLang=document.getElementById("lang").value;
    try{ await api("/api/lang","POST",{lang:newLang}); } catch(e){}
    LANG=newLang;
    setUi();
    await refreshStatus().catch(()=>{});
    await loadDaily(true);
  };

  (async ()=>{
    try{
      await refreshStatus();
      await loadDaily(true);
    }catch(e){
      dbg("ERROR: " + e.message);
      showPopup("Error", e.message);
    }
  })();
</script>
</body>
</html>
